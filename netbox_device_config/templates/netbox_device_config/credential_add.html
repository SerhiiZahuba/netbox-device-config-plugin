{% extends 'base/layout.html' %}
{% load static %}
{% block content %}
<h2>Add Device Credential</h2>
<form method="post">
    {% csrf_token %}
    <div class="form-group mb-3">
        <label for="device">Device:</label>
        <select id="device" name="device" class="form-control" onchange="fetchDeviceIP()" required>
            <option value="">Select device...</option>
            {% for d in devices %}
            <option value="{{ d.id }}">{{ d.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group mb-3">
        <label for="host">Host (Primary IP):</label>
        <input type="text" id="host" name="host" class="form-control" placeholder="Will autofill..." required>
    </div>

    <div class="form-group mb-3">
        <label for="port">Port:</label>
        <input type="number" id="port" name="port" value="22" class="form-control">
    </div>

    <div class="form-group mb-3">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" class="form-control" required>
    </div>

    <div class="form-group mb-3">
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" class="form-control" required>
    </div>

    <select id="template" name="template" class="form-control">
        <option value="">— Select Template —</option>
        {% for t in templates %}
        <option value="{{ t.id }}">{{ t.vendor }} — {{ t.command }}</option>
        {% endfor %}
    </select>



    <button type="submit" class="btn btn-primary">Save</button>
    <a href="{% url 'plugins:netbox_device_config:devicecredential_list' %}" class="btn btn-secondary">Cancel</a>
</form>

<script>
    async function fetchDeviceIP() {
        const deviceSelect = document.getElementById('device');
        const hostInput = document.getElementById('host');
        const deviceId = deviceSelect.value;

        if (!deviceId) {
            hostInput.value = '';
            return;
        }

        try {
            const response = await fetch(`/api/dcim/devices/${deviceId}/`);
            if (!response.ok) throw new Error('Failed to fetch device info');

            const device = await response.json();
            if (device.primary_ip4 && device.primary_ip4.address) {
                hostInput.value = device.primary_ip4.address.split('/')[0];
            } else {
                hostInput.value = '';
                alert('Device has no primary IP assigned.');
            }
        } catch (error) {
            console.error(error);
            alert('Error fetching device IP.');
        }
    }
</script>
{% endblock %}
